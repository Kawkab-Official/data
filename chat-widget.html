<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Ø¨ÙˆØª ÙƒÙˆÙƒØ¨ â€” ÙØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø±</title>
<style>
:root{
--accent:#0f1724;
--accent-2:#0ea5a4;
--bg:#f7fbff;
--card:#ffffff;
--user-bg:#0ea5a4;
--user-text:#ffffff;
--bot-bg:#f3f4f6;
--bot-text:#1f2937;
--muted:#667085;
--radius:16px;
--shadow:0 2px 8px rgba(0,0,0,0.1);
}

/* Reset */
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;background:transparent;font-family:"Tahoma",system-ui;overflow:hidden}

/* FAB */
.chat-fab {
position:fixed;
bottom:calc(20px + env(safe-area-inset-bottom, 0px));
right:20px;
z-index:9999;
width:60px;height:60px;border-radius:50%;
background:linear-gradient(135deg,var(--accent-2),var(--accent));
display:flex;align-items:center;justify-content:center;color:#fff;font-size:26px;
cursor:pointer;box-shadow:0 4px 12px rgba(14,165,164,0.4);
transition:transform .25s,opacity .25s;
}
.chat-fab:hover{transform:scale(1.05)}
.chat-fab.hidden{opacity:0;pointer-events:none}

/* Overlay and box */
.chat-overlay {
position:fixed;
top:0;
left:0;
right:0;
bottom:0;
display:none;
background:rgba(0,0,0,0.5);
z-index:10000;
-webkit-backdrop-filter: blur(8px);
backdrop-filter: blur(8px);
}
.chat-overlay.show{display:block}

.chat-box {
position:absolute;
top:0;
left:0;
right:0;
bottom:0;
background:linear-gradient(to bottom, #f9fafb 0%, #ffffff 100%);
display:grid;
grid-template-rows: auto 1fr auto;
overflow:hidden;
}

/* HEADER: Ø£Ø¨ÙŠØ¶/Ø£Ø³ÙˆØ¯ Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨ */
.header {
background:#ffffff; /* Ø£Ø¨ÙŠØ¶ */
color:#000000; /* Ø£Ø³ÙˆØ¯ */
padding:16px 12px;
padding-top:calc(16px + env(safe-area-inset-top,0px));
display:flex;
align-items:center;
box-shadow:0 2px 12px rgba(0,0,0,0.06);
}
.header .title{
flex:1;
font-weight:700;
font-size:17px;
white-space:nowrap;
overflow:hidden;
text-overflow:ellipsis;
display:flex;
align-items:center;
gap:8px;
}
.header .title::before{content:'ğŸ’¬'}
.header .close{
cursor:pointer;
font-size:26px;
background:rgba(0,0,0,0.06);
border:none;
color:#000;
width:38px;
height:38px;
display:flex;
align-items:center;
justify-content:center;
padding:0;
border-radius:50%;
transition:background .2s;
}
.header .close:hover{background:rgba(0,0,0,0.12)}

/* area, controls */
.area{
overflow-y:auto;
overflow-x:hidden;
padding:16px 12px;
padding-bottom:40px;
display:flex;
flex-direction:column;
gap:12px;
-webkit-overflow-scrolling:touch;
scroll-behavior:smooth;
}

.controls{
background:#ffffff;
border-top:1px solid #e5e7eb;
padding:12px;
padding-bottom:80px;
display:flex;
flex-direction:column;
gap:10px;
box-shadow:0 -4px 16px rgba(0,0,0,0.06);
}

/* Timer Display */
.timer-container{
display:none;
align-items:center;
justify-content:center;
padding:12px;
background:linear-gradient(135deg, #fef3c7, #fde68a);
border-radius:12px;
gap:8px;
animation:pulse 2s ease-in-out infinite;
}
.timer-container.active{display:flex}
.timer-text{
font-size:14px;
font-weight:600;
color:#92400e;
}
.timer-count{
font-size:18px;
font-weight:700;
color:#b45309;
min-width:35px;
text-align:center;
}
@keyframes pulse{
0%,100%{transform:scale(1)}
50%{transform:scale(1.02)}
}

/* input and send button */
.input{
display:flex;
gap:8px;
align-items:stretch;
}
.input input{
flex:1;
padding:14px 16px;
border-radius:24px;
border:2px solid #e5e7eb;
font-size:15px;
min-width:0;
background:#ffffff;
transition:border-color .2s, box-shadow .2s;
}
.input input:focus{
outline:none;
border-color:var(--accent-2);
box-shadow:0 0 0 3px rgba(14,165,164,0.1);
}
/* Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: Ø£Ø³ÙˆØ¯ Ø¨Ø®Ø· Ø£Ø¨ÙŠØ¶ */
.btn{
padding:12px 24px;
border-radius:24px;
border:none;
background:#000000; /* Ø£Ø³ÙˆØ¯ */
color:#ffffff; /* Ø£Ø¨ÙŠØ¶ */
cursor:pointer;
font-weight:600;
min-width:80px;
box-shadow:0 2px 8px rgba(0,0,0,0.15);
transition:transform .2s, box-shadow .2s;
}
.btn:hover{
transform:translateY(-1px);
box-shadow:0 6px 18px rgba(0,0,0,0.22);
}
.btn:active{ transform:translateY(0); }
.btn:disabled{ opacity:0.6; cursor:not-allowed; transform:none; }

.quick{display:flex;gap:8px;flex-wrap:wrap}
.quick button{
padding:10px 16px;
border-radius:20px;
border:2px solid #e5e7eb;
background:#ffffff;
font-size:13px;
cursor:pointer;
color:var(--accent);
font-weight:500;
transition:all .2s;
}
.quick button:hover{
border-color:var(--accent-2);
background:#f0fdfa;
transform:translateY(-1px);
}

/* msgs */
.msg{
display:flex;
max-width:80%;
flex-direction:column;
word-break:break-word;
animation:slideIn .3s ease-out;
}
@keyframes slideIn{
from{opacity:0;transform:translateY(10px)}
to{opacity:1;transform:translateY(0)}
}
.msg.user{ align-self:flex-end; align-items:flex-end; }
.msg.user .bubble{
background:linear-gradient(135deg,var(--accent-2),var(--accent));
color:var(--user-text);
border-radius:18px 18px 4px 18px;
padding:12px 16px;
box-shadow:var(--shadow);
}
.msg.bot{ align-self:flex-start; align-items:flex-start; }
.msg.bot .bubble{ background:var(--bot-bg); color:var(--bot-text); border-radius:18px 18px 18px 4px; padding:12px 16px; box-shadow:var(--shadow); border:1px solid #e5e7eb; }

.meta{ font-size:11px; color:var(--muted); margin-top:6px; padding:0 4px; }

.typing{ display:flex; gap:4px; padding:4px 0; }
.typing span{ width:8px; height:8px; background:var(--muted); border-radius:50%; display:inline-block; animation:dot 1.4s infinite; }
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes dot{0%,60%,100%{opacity:.3;transform:translateY(0) scale(0.8)}30%{opacity:1;transform:translateY(-6px) scale(1)}}

/* Result styling */
.result-msg{
background:linear-gradient(135deg, #dcfce7, #bbf7d0);
border:2px solid #86efac;
border-radius:16px;
padding:16px;
margin:8px 0;
text-align:center;
animation:celebrate .6s ease-out;
}
.result-msg .result-title{ font-size:18px; font-weight:700; color:#15803d; margin-bottom:8px; }
.result-msg .result-value{ font-size:32px; font-weight:900; color:#16a34a; text-shadow:0 2px 4px rgba(22,163,74,0.2); }
@keyframes celebrate{0%{transform:scale(0.8) rotate(-5deg);opacity:0}50%{transform:scale(1.05) rotate(2deg)}100%{transform:scale(1) rotate(0);opacity:1} }

@media (min-width:700px){
.chat-overlay{ display:none; align-items:center; justify-content:center; }
.chat-overlay.show{ display:flex }
.chat-box{ position:relative; width:640px; height:90vh; max-height:800px; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
.chat-fab{right:28px;bottom:28px}
}
</style>
</head>
<body>

<div class="chat-fab" id="openChat" role="button" aria-label="Ø§ÙØªØ­ Ø§Ù„Ø´Ø§Øª">ğŸ’¬</div>

<div class="chat-overlay" id="chatOverlay" aria-hidden="true">
<div class="chat-box" role="dialog" aria-modal="true" aria-label="Ø¨ÙˆØª ÙƒÙˆÙƒØ¨">
<div class="header">
  <div class="title">Ø¨ÙˆØª ÙƒÙˆÙƒØ¨ â€” ÙØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø±</div>
  <button class="close" id="closeChat" aria-label="Ø§ØºÙ„Ø§Ù‚">Ã—</button>
</div>

<div class="area" id="area" tabindex="0" aria-live="polite" aria-atomic="false"></div>

<div class="controls">
  <div class="timer-container" id="timerContainer">
    <span class="timer-text">â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
    <span class="timer-count" id="timerDisplay">60</span>
    <span class="timer-text">Ø«Ø§Ù†ÙŠØ©</span>
  </div>

  <div class="quick" id="quickActions" aria-hidden="false">
    <button data-text="Ø£Ø±ÙŠØ¯ Ø£ÙØ¶Ù„ Ø¹Ø±Ø¶">ğŸ¯ Ø£ÙØ¶Ù„ Ø¹Ø±Ø¶</button>
    <button data-text="Ù‡Ù„ ÙÙŠ Ø®ØµÙ… Ø£Ø¹Ù„Ù‰ØŸ">ğŸ’° Ø®ØµÙ… Ø£Ø¹Ù„Ù‰</button>
    <button data-text="ØªÙ…Ø§Ù…" data-finalize="true">âœ… ØªÙ…Ø§Ù…</button>
  </div>

  <div class="input">
    <input id="inp" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." aria-label="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ" autocomplete="off" />
    <button id="btn" class="btn" aria-label="Ø£Ø±Ø³Ù„">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>
</div>
</div>

<script>
(function(){
'use strict';

const openBtn = document.getElementById('openChat');
const overlay = document.getElementById('chatOverlay');
const closeBtn = document.getElementById('closeChat');
const area = document.getElementById('area');
const inp = document.getElementById('inp');
const btn = document.getElementById('btn');
const quick = document.getElementById('quickActions');
const timerContainer = document.getElementById('timerContainer');
const timerDisplay = document.getElementById('timerDisplay');

const WORKER_URL = 'https://kawkab.kawkab-arabia.workers.dev/';

let historyMessages = [], chatOpened = false, finalized = false;
let timerInterval = null;
let timeRemaining = 60;
let botRepliesCount = 0;

function postToParent(action){
  try{ if(window.parent && window.parent !== window){ window.parent.postMessage({action}, '*'); } }catch(e){}
}

function safeText(s){
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function scrollToBottom(){
  requestAnimationFrame(()=>{ area.scrollTop = area.scrollHeight; });
}

function append(who, text, isResult = false){
  const w = document.createElement('div');
  w.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
  const b = document.createElement('div');
  b.className = isResult ? 'result-msg' : 'bubble';
  if(isResult){
    b.innerHTML = `<div class="result-title">ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø®ØµÙ…Ùƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div><div class="result-value">${safeText(text)}</div>`;
  } else {
    b.innerHTML = safeText(text);
  }
  w.appendChild(b);
  if(!isResult){
    const m = document.createElement('div');
    m.className = 'meta';
    const now = new Date();
    const time = now.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
    m.textContent = time;
    w.appendChild(m);
  }
  area.appendChild(w);
  scrollToBottom();

  if (who === 'bot') {
    botRepliesCount++;
    // Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ø±Ø¯ Ù…Ù† Ø§Ù„Ø¨ÙˆØª
    if (botRepliesCount === 1) startTimer();
  }
}

function showTyping(){
  const el = document.createElement('div');
  el.className = 'msg bot';
  el.innerHTML = '<div class="bubble"><div class="typing" aria-hidden="true"><span></span><span></span><span></span></div></div>';
  area.appendChild(el);
  scrollToBottom();
  return el;
}

function startTimer(){
  if(timerInterval) return;
  timeRemaining = 60;
  timerContainer.classList.add('active');
  timerDisplay.textContent = timeRemaining;
  timerInterval = setInterval(()=>{
    timeRemaining--;
    timerDisplay.textContent = timeRemaining;
    if(timeRemaining <= 0){
      stopTimer();
      finalize(true); // ÙØ±Ø¶Ø§Ù‹ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø© ÙŠØ¹Ù†ÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙØ§ÙˆØ¶
    }
  }, 1000);
}

function stopTimer(){
  if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
  timerContainer.classList.remove('active');
}

function computeFinalPercentFromHistory() {
  // ÙŠØ¨Ø­Ø« Ø¹Ù† Ø¢Ø®Ø± Ù†Ø³Ø¨Ø© Ù‚Ø¯Ù…Ù‡Ø§ Ø§Ù„Ø¨ÙˆØª (Ù…Ø«Ù„ 15%)
  const re = /(\d{1,3})\s*%/g;
  for (let i = historyMessages.length - 1; i >= 0; i--) {
    const m = historyMessages[i];
    if (m && m.role === 'assistant' && typeof m.content === 'string') {
      let match;
      while ((match = re.exec(m.content)) !== null) {
        const n = parseInt(match[1], 10);
        if (!Number.isNaN(n)) {
          return Math.min(30, n);
        }
      }
    }
  }
  return 5; // Ø§ÙØªØ±Ø§Ø¶ÙŠ
}

async function sendToWorker(payload){
  try{
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload),
    });
    return res;
  }catch(e){
    throw e;
  }
}

// finalize: Ø¥Ø°Ø§ ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡ Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª Ø£Ùˆ Ø¨Ù†Ù‚Ø±Ø© "ØªÙ…Ø§Ù…"
// param fromTimeout:boolean Ù„Ùˆ Ø§ØªÙ†Ù‡Ù‰ Ø§Ù„Ø¹Ø¯Ø§Ø¯
async function finalize(fromTimeout = false){
  if(finalized) return;
  finalized = true;
  stopTimer();
  btn.disabled = true;
  inp.disabled = true;
  quick.style.display = 'none';

  try {
    // Ù†Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù€ Worker Ø­Ø³Ø§Ø¨ finalize (Ø£ÙˆÙ„Ø§Ù‹) â€” Ù„Ùˆ ÙØ´Ù„ Ù†Ø¹Ù…Ù„ fallback Ù…Ø­Ù„ÙŠ
    const res = await sendToWorker({ messages: historyMessages, finalize: true });
    if (res && res.ok) {
      const j = await res.json().catch(()=> ({}));
      const percent = Number.isFinite(Number(j.percent)) ? Number(j.percent) : computeFinalPercentFromHistory();
      append('bot', `${percent}%`, true);
      setTimeout(()=> append('bot', 'Ø´ÙƒØ±Ø§Ù‹ Ù„ÙŠÙƒ! ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¶ ÙˆÙ‡Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ø§Ùƒ Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§Ù‹ ğŸŠ'), 1000);
      return;
    }
  } catch (e) {
    // ØªØ¬Ø§Ù‡Ù„Ø› Ù†Ø¹Ù…Ù„ fallback Ù…Ø­Ù„ÙŠ
  }

  // fallback Ù…Ø­Ù„ÙŠ Ù„Ùˆ Ø§Ù„Ù€ Worker Ù…Ø´ Ø´ØºØ§Ù„
  const percentLocal = computeFinalPercentFromHistory();
  append('bot', `${percentLocal}%`, true);
  setTimeout(()=> append('bot', 'Ø´ÙƒØ±Ø§Ù‹ Ù„ÙŠÙƒ! ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¶ ÙˆÙ‡Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ø§Ùƒ Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§Ù‹ ğŸŠ'), 1000);
}

// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù€ input Ù„Ù…Ø§ ÙŠÙØªØ­ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯
inp.addEventListener('focus', ()=>{
  setTimeout(()=>{
    const controls = document.querySelector('.controls');
    if(controls){ controls.scrollIntoView({behavior:'smooth', block:'nearest'}); }
  }, 300);
});

// Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø© (Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯)
if(window.visualViewport){
  window.visualViewport.addEventListener('resize', ()=>{
    setTimeout(()=>{
      const controls = document.querySelector('.controls');
      if(controls){ controls.scrollIntoView({behavior:'smooth', block:'end'}); }
    }, 100);
  });
}

function openChat(){
  overlay.classList.add('show');
  overlay.setAttribute('aria-hidden', 'false');
  openBtn.classList.add('hidden');
  if(!chatOpened){
    // Ø§Ø¨Ø¹Ø« Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ù…Ù† Ø§Ù„Ø¨ÙˆØª (Ø³ØªÙØ´ØºÙ‘Ù„ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ø¹Ø¯ Ø¸Ù‡ÙˆØ±Ù‡Ø§ Ø¨ÙØ¶Ù„ botRepliesCount logic)
    append('bot', 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙÙŠ Ø¨ÙˆØª ÙƒÙˆÙƒØ¨! ğŸ‰ Ù‚ÙˆÙ„Ù‘ÙŠ Ø¥Ù†Øª Ø¹Ø§ÙŠØ² ØªÙØ§ÙˆØ¶ Ø¹Ù„Ù‰ Ø¥ÙŠÙ‡ØŸ ğŸ˜');
    chatOpened = true;
  }
  postToParent('chatOpened');
  setTimeout(()=>{ scrollToBottom(); inp.focus(); }, 400);
}

function closeChat(){
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden', 'true');
  openBtn.classList.remove('hidden');
  postToParent('chatClosed');
  inp.blur();
  setTimeout(()=> openBtn.focus(), 200);
}

async function sendMessage(isFinal = false){
  const txt = inp.value.trim();
  if(!txt || finalized) return;
  append('user', txt);
  inp.value = '';

  if (isFinal) {
    // Ø¨Ø¹Ø« Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø«Ù… Ø§Ø·Ù„Ø¨ finalize Ù…Ù† Ø§Ù„Ù€ Worker
    historyMessages.push({ role: 'user', content: txt });
    // Ø­Ø§ÙˆÙ„ Ù†Ø¬ÙŠØ¨ finalize Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Worker)
    try {
      btn.disabled = true;
      inp.disabled = true;
      const res = await sendToWorker({ messages: historyMessages, finalize: true });
      if (res && res.ok) {
        const j = await res.json().catch(()=> ({}));
        const percent = Number.isFinite(Number(j.percent)) ? Number(j.percent) : computeFinalPercentFromHistory();
        finalized = true;
        stopTimer();
        append('bot', `${percent}%`, true);
        setTimeout(()=> append('bot', 'Ø´ÙƒØ±Ø§Ù‹ Ù„ÙŠÙƒ! ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¶ ÙˆÙ‡Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ø§Ùƒ Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§Ù‹ ğŸŠ'), 1000);
        return;
      }
    } catch (e) {
      // fallback handled below
    } finally {
      btn.disabled = false;
      inp.disabled = false;
    }

    // fallback Ù…Ø­Ù„ÙŠ
    finalize();
    return;
  }

  // normal flow
  const typing = showTyping();
  btn.disabled = true;
  inp.disabled = true;

  try{
    // Ù†Ø¨Ø¹Øª Ù„Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© history + Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ù€ Worker Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¯
    const payloadMessages = historyMessages.concat([{ role: 'user', content: txt }]);
    const res = await sendToWorker({ messages: payloadMessages });
    typing.remove();
    if(!res || !res.ok){
      append('bot', 'Ø§Ù„Ù†Øª ÙØ§ØµÙ„ ÙˆÙ„Ø§ ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± ğŸ˜…');
    } else {
      const j = await res.json().catch(()=> ({}));
      const reply = j.text || j.reply || 'Ù…Ø´ ÙØ§Ù‡Ù…Ùƒ Ù‚ÙˆÙŠ ğŸ˜… Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ';
      append('bot', reply);
      // Ø®Ø²Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„Ù‡Ø³ØªÙˆØ±ÙŠ
      historyMessages.push({ role: 'user', content: txt }, { role: 'assistant', content: reply });
    }
  }catch(e){
    try{ typing.remove(); }catch(_){}
    append('bot', 'Ø§Ù„Ù†Øª ÙØ§ØµÙ„ ÙˆÙ„Ø§ Ø¥ÙŠÙ‡ØŸ ğŸ˜…');
  } finally {
    btn.disabled = false;
    inp.disabled = false;
    inp.focus();
  }
}

openBtn.addEventListener('click', openChat);
closeBtn.addEventListener('click', closeChat);
btn.addEventListener('click', ()=> sendMessage());

inp.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter') sendMessage();
});

quick.addEventListener('click', (e)=>{
  if(e.target.tagName === 'BUTTON'){
    const text = e.target.dataset.text || '';
    const isFinal = e.target.dataset.finalize === 'true';
    inp.value = text;
    if(text){
      sendMessage(isFinal);
    }
  }
});

window.addEventListener('message', (ev)=>{
  if(!ev.data || typeof ev.data.action !== 'string') return;
  if(ev.data.action === 'closeChat') closeChat();
  if(ev.data.action === 'focusInput'){
    if(overlay.classList.contains('show')) setTimeout(()=> inp.focus(), 200);
  }
});

window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && overlay.classList.contains('show')) closeChat();
});

overlay.addEventListener('touchmove', (e)=>{
  if(e.target === overlay) e.preventDefault();
}, {passive:false});

window.__KAWKAB_CHAT = {
  open: openChat,
  close: closeChat,
  sendMessageText: (t)=>{
    inp.value = t;
    sendMessage();
  }
};
})();
</script>
</body>
</html>
