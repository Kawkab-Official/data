<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Ø¨ÙˆØª ÙƒÙˆÙƒØ¨ â€” ÙØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø±</title>
<style>
:root{
  --accent:#0f1724;
  --accent-2:#0ea5a4;
  --bg:#f7fbff;
  --card:#ffffff;
  --user-bg:#dff7ff;
  --bot-bg:#fff8e6;
  --muted:#667085;
  --radius:16px;
  --vh:1vh; /* Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ø¹Ø¨Ø± JS Ù„ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø´Ø±ÙŠØ· Ø§Ù„Ù…ØªØµÙØ­ */
}

/* reset */
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;background:transparent;font-family:"Tahoma",system-ui;overflow:hidden}

/* Floating button (Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ iframe) */
.chat-fab {
  position:fixed;
  bottom:calc(20px + env(safe-area-inset-bottom, 0px));
  right:20px;
  z-index:9999;
  width:60px;height:60px;border-radius:50%;
  background:linear-gradient(135deg,var(--accent-2),var(--accent));
  display:flex;align-items:center;justify-content:center;color:#fff;font-size:26px;
  cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.18);
  transition:transform .25s,opacity .25s;
}
.chat-fab:hover{transform:scale(1.05)}
.chat-fab.hidden{opacity:0;pointer-events:none}

/* overlay full screen (ØªØ­Ø³Ø¨ Ø§Ø±ØªÙØ§Ø¹ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§) */
.chat-overlay {
  position:fixed;inset:0;
  display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.45);z-index:10000;
  -webkit-backdrop-filter: blur(6px);
  backdrop-filter: blur(6px);
}

/* show */
.chat-overlay.show{display:flex}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø´Ø§Øª - Ù†Ø³ØªØ®Ø¯Ù… vh Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ */
.chat-box {
  width:100%;
  height:calc(var(--vh) * 100);
  max-height:100dvh;
  background:var(--card);
  display:flex;flex-direction:column;position:relative;
  border-radius:12px 12px 0 0;
  overflow:hidden;
  box-shadow:0 10px 30px rgba(2,6,23,0.12);
}

/* Ø§Ù„Ù‡ÙŠØ¯Ø±: Ù†Ø£Ø®Ø° ÙÙŠ Ø§Ù„Ø­Ø³Ø¨Ø§Ù† safe-area-inset-top Ø­ØªÙ‰ Ù„Ø§ ÙŠØ®ØªÙÙŠ ØªØ­Øª Ø´Ø±ÙŠØ· Ø§Ù„Ù…ØªØµÙØ­ */
.header {
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#fff;padding:12px 12px;
  display:flex;align-items:center;flex-shrink:0;
  position:sticky;top:env(safe-area-inset-top,0px);z-index:100;
  padding-top:calc(12px + env(safe-area-inset-top,0px));
}
.header .title{flex:1;font-weight:700;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.header .close{cursor:pointer;font-size:28px;background:none;border:none;color:#fff;width:36px;height:36px;display:flex;align-items:center;justify-content:center;padding:0}

/* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ…Ø±ÙŠØ± (ÙˆÙ†Ø¹Ø·ÙŠÙ‡ min-height:0 Ù„ØªÙØ§Ø¯ÙŠ Ù…Ø´Ø§ÙƒÙ„ flex-scroll) */
.area{
  flex:1; padding:12px; overflow-y:auto; overflow-x:hidden;
  display:flex;flex-direction:column;gap:8px;min-height:0;
  -webkit-overflow-scrolling:touch;
  scroll-behavior:smooth;
}

/* Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ - Ù†Ø£Ø®Ø° safe-area-inset-bottom */
.controls{
  padding:10px 12px  calc(12px + env(safe-area-inset-bottom,0px));
  border-top:1px solid #eee;display:flex;flex-direction:column;gap:8px;flex-shrink:0;background:var(--card);
}
.input{display:flex;gap:8px;align-items:center}
.input input{
  flex:1;padding:10px;border-radius:14px;border:1px solid #e6eef6;font-size:14px;min-width:0;
}
.btn{padding:10px 14px;border-radius:14px;border:none;background:var(--accent);color:#fff;cursor:pointer}
.quick{display:flex;gap:8px;flex-wrap:wrap}
.quick button{padding:8px;border-radius:12px;border:1px dashed #ccc;background:transparent;font-size:13px;cursor:pointer;color:var(--accent)}

/* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
.msg{display:flex;max-width:85%;flex-direction:column;word-break:break-word}
.msg.user{align-self:flex-end}
.msg.user .bubble{background:var(--user-bg);border-radius:16px 16px 0 16px;padding:10px 14px}
.msg.bot{align-self:flex-start}
.msg.bot .bubble{background:var(--bot-bg);border-radius:16px 16px 16px 0;padding:10px 14px}
.meta{font-size:11px;color:var(--muted);margin-top:4px;text-align:right}

/* typing animation */
.typing span{width:6px;height:6px;background:var(--muted);border-radius:50%;display:inline-block;animation:dot 1s infinite}
.typing span:nth-child(2){animation-delay:.18s}
.typing span:nth-child(3){animation-delay:.36s}
@keyframes dot{0%,100%{opacity:.3;transform:translateY(0)}50%{opacity:1;transform:translateY(-4px)}}

/* responsive tweaks */
@media (min-width:700px){
  .chat-box{width:640px;border-radius:14px}
  .chat-fab{right:28px;bottom:28px}
}
</style>
</head>
<body>
<!-- Floating button Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ iframe -->
<div class="chat-fab" id="openChat" role="button" aria-label="Ø§ÙØªØ­ Ø§Ù„Ø´Ø§Øª">ğŸ’¬</div>

<!-- Overlay Ø§Ù„Ø´Ø§Øª -->
<div class="chat-overlay" id="chatOverlay" aria-hidden="true">
  <div class="chat-box" role="dialog" aria-modal="true" aria-label="Ø¨ÙˆØª ÙƒÙˆÙƒØ¨">
    <div class="header">
      <div class="title">Ø¨ÙˆØª ÙƒÙˆÙƒØ¨ â€” ÙØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø±</div>
      <button class="close" id="closeChat" aria-label="Ø§ØºÙ„Ø§Ù‚">Ã—</button>
    </div>

    <div class="area" id="area" tabindex="0" aria-live="polite" aria-atomic="false"></div>

    <div class="controls">
      <div class="quick" id="quickActions" aria-hidden="false">
        <button data-text="Ø£Ø±ÙŠØ¯ Ø£ÙØ¶Ù„ Ø¹Ø±Ø¶">Ø£ÙØ¶Ù„ Ø¹Ø±Ø¶</button>
        <button data-text="Ù‡Ù„ ÙÙŠ Ø®ØµÙ… Ø£Ø¹Ù„Ù‰ØŸ">Ø®ØµÙ… Ø£Ø¹Ù„Ù‰</button>
        <button data-text="ØªÙ…Ø§Ù…">ØªÙ…Ø§Ù…</button>
      </div>

      <div class="input">
        <input id="inp" type="text" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..." aria-label="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ" autocomplete="off" />
        <button id="btn" class="btn" aria-label="Ø£Ø±Ø³Ù„">Ø£Ø±Ø³Ù„</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';

  // ====== Ø¥Ø¹Ø¯Ø§Ø¯ vh Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù„Ù…Ø´Ø§ÙƒÙ„ Ø´Ø±ÙŠØ· Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ======
  function setVh(){
    // use window.innerHeight to account for browser chrome (address bar)
    document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
  }
  window.addEventListener('resize', setVh);
  window.addEventListener('orientationchange', function(){ setTimeout(setVh,300); });
  setVh();

  // ===== Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© =====
  const openBtn = document.getElementById('openChat');
  const overlay = document.getElementById('chatOverlay');
  const closeBtn = document.getElementById('closeChat');
  const area = document.getElementById('area');
  const inp = document.getElementById('inp');
  const btn = document.getElementById('btn');
  const quick = document.getElementById('quickActions');

  // Worker URL - Ø§ØªØ±ÙƒÙ‡ ÙƒÙ…Ø§ ÙƒØ§Ù† Ø£Ùˆ Ø¹Ø¯Ù‘Ù„Ù‡ Ù„Ùˆ Ù„Ø²Ù…
  const WORKER_URL = 'https://kawkab.kawkab-arabia.workers.dev/';

  // Ø­Ø§Ù„Ø© Ø³Ø±ÙŠØ¹Ø©
  let historyMessages = [], chatOpened = false, finalized = false;

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø£Ø¨ (parent) Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­/Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ - Ù„ÙŠØªØ¹Ø§Ù…Ù„ Ø§Ù„Ù€ parent Ù…Ø¹ overflow
  function postToParent(action){
    try{
      if(window.parent && window.parent !== window){
        window.parent.postMessage({action}, '*');
      }
    }catch(e){}
  }

  // Append message Ø«Ù… ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù€ scrolling Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Ù†Ø³ØªØ®Ø¯Ù… scrollIntoView)
  function safeText(s){
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  function append(who, text){
    const w = document.createElement('div');
    w.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
    const b = document.createElement('div');
    b.className = 'bubble';
    b.innerHTML = safeText(text);
    w.appendChild(b);
    const m = document.createElement('div');
    m.className = 'meta';
    // use 24-hour H:M without seconds
    const now = new Date();
    const time = now.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
    m.textContent = time;
    w.appendChild(m);
    area.appendChild(w);

    // scroll new message into view safely
    // use requestAnimationFrame to ensure layout updated
    requestAnimationFrame(()=>{
      try{
        // prefer scrollIntoView to avoid messages going out of viewport
        w.scrollIntoView({behavior:'smooth', block:'nearest'});
      }catch(e){
        area.scrollTop = area.scrollHeight - area.clientHeight;
      }
    });
  }

  // show typing indicator element (returns element to remove later)
  function showTyping(){
    const el = document.createElement('div');
    el.className = 'msg bot';
    el.innerHTML = '<div class="bubble"><div class="typing" aria-hidden="true"><span></span><span></span><span></span></div></div>';
    area.appendChild(el);
    // ensure visible
    requestAnimationFrame(()=> el.scrollIntoView({behavior:'smooth', block:'nearest'}));
    return el;
  }

  // auto-scroll when keyboard opens or input focused
  inp.addEventListener('focus', ()=> {
    // small timeout so that mobile keyboard resize finishes
    setTimeout(()=> {
      // scroll last message or area to bottom
      if(area.lastElementChild) area.lastElementChild.scrollIntoView({behavior:'smooth', block:'nearest'});
    }, 300);
  });

  // also monitor viewport changes (mobile keyboard show/hide)
  let lastInnerHeight = window.innerHeight;
  setInterval(()=> {
    if(Math.abs(window.innerHeight - lastInnerHeight) > 120){
      // big change -> probably keyboard open/close -> recalc vh and scroll
      lastInnerHeight = window.innerHeight;
      setVh();
      if(area.lastElementChild) area.lastElementChild.scrollIntoView({behavior:'smooth', block:'nearest'});
    }
  }, 300);

  // init messages when first open
  function openChat(){
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden', 'false');
    openBtn.classList.add('hidden');
    if(!chatOpened){
      append('bot', 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙÙŠ Ø¨ÙˆØª ÙƒÙˆÙƒØ¨! Ù‚ÙˆÙ„Ù‘ÙŠ Ø¥Ù†Øª Ø¹Ø§ÙŠØ² ØªÙØ§ÙˆØ¶ Ø¹Ù„Ù‰ Ø¥ÙŠÙ‡ØŸ ğŸ˜');
      chatOpened = true;
    }
    postToParent('chatOpened');
    // focus input after open
    setTimeout(()=> inp.focus(), 400);
  }

  function closeChat(){
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden', 'true');
    openBtn.classList.remove('hidden');
    postToParent('chatClosed');
    // return focus to fab
    setTimeout(()=> openBtn.focus(), 200);
  }

  // send payload to worker
  async function sendToWorker(payload){
    try{
      const res = await fetch(WORKER_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload),
      });
      return res;
    }catch(e){
      throw e;
    }
  }

  // send message flow
  async function sendMessage(){
    const txt = inp.value.trim();
    if(!txt || finalized) return;
    append('user', txt);
    inp.value = '';
    const typing = showTyping();
    btn.disabled = true;
    inp.disabled = true;

    try{
      const res = await sendToWorker({messages: historyMessages.concat([{role:'user', content: txt}])});
      typing.remove();
      if(!res || !res.ok){
        append('bot', 'Ø§Ù„Ù†Øª ÙØ§ØµÙ„ ÙˆÙ„Ø§ ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± ğŸ˜…');
      } else {
        const j = await res.json().catch(()=> ({}));
        const reply = j.text || j.reply || 'Ù…Ø´ ÙØ§Ù‡Ù…Ùƒ Ù‚ÙˆÙŠ ğŸ˜… Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ';
        append('bot', reply);
        historyMessages.push({role:'user', content: txt}, {role:'assistant', content: reply});
      }
    }catch(e){
      try{ typing.remove(); }catch(_){}
      append('bot', 'Ø§Ù„Ù†Øª ÙØ§ØµÙ„ ÙˆÙ„Ø§ Ø¥ÙŠÙ‡ØŸ ğŸ˜…');
    } finally {
      btn.disabled = false;
      inp.disabled = false;
      inp.focus();
    }
  }

  // Events
  openBtn.addEventListener('click', openChat);
  closeBtn.addEventListener('click', closeChat);

  btn.addEventListener('click', sendMessage);
  inp.addEventListener('keydown', (e)=> { if(e.key === 'Enter') sendMessage(); });

  quick.addEventListener('click', (e)=> {
    if(e.target.tagName === 'BUTTON'){
      inp.value = e.target.dataset.text || '';
      inp.focus();
    }
  });

  // ensure that new messages keep visible on DOM changes (MutationObserver)
  const mo = new MutationObserver((mutations)=> {
    // if user is near bottom, keep auto-scrolling
    const threshold = 120;
    const nearBottom = (area.scrollHeight - area.scrollTop - area.clientHeight) < threshold;
    if(nearBottom){
      // scroll last child into view
      const last = area.lastElementChild;
      if(last) last.scrollIntoView({behavior:'smooth', block:'nearest'});
    }
  });
  mo.observe(area, {childList:true, subtree:false});

  // listen to parent messages in case parent decides to force-close or adjust
  window.addEventListener('message', (ev)=> {
    if(!ev.data || typeof ev.data.action !== 'string') return;
    if(ev.data.action === 'closeChat'){
      closeChat();
    }
    // parent could also send focus commands
    if(ev.data.action === 'focusInput'){
      if(overlay.classList.contains('show')) setTimeout(()=> inp.focus(), 200);
    }
  });

  // Accessibility: close on Escape
  window.addEventListener('keydown', (e)=> {
    if(e.key === 'Escape' && overlay.classList.contains('show')){
      closeChat();
    }
  });

  // Prevent accidental page scroll inside iframe when overlay open (best-effort)
  overlay.addEventListener('touchmove', (e)=> {
    // allow internal scrolling but prevent parent scrolling
    e.stopPropagation();
  }, {passive:false});

  // initial small check to ensure area is scrolled to bottom if any preloaded content exists
  setTimeout(()=> {
    if(area.lastElementChild) area.lastElementChild.scrollIntoView({block:'nearest'});
  }, 200);

  // expose a small debug for parent if needed
  window.__KAWKAB_CHAT = {
    open: openChat,
    close: closeChat,
    sendMessageText: (t)=> { inp.value = t; sendMessage(); }
  };

})();
</script>
</body>
</html>
