<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Ø¨ÙˆØª ÙƒÙˆÙƒØ¨ â€” ÙØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø±</title>
<style>
:root{
--accent:#0f1724;
--accent-2:#0ea5a4;
--bg:#f7fbff;
--card:#ffffff;
--user-bg:#dff7ff;
--bot-bg:#fff8e6;
--muted:#667085;
--radius:16px;
}

*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;background:transparent;font-family:"Tahoma",system-ui;overflow:hidden}

.chat-fab {
position:fixed;
bottom:calc(20px + env(safe-area-inset-bottom, 0px));
right:20px;
z-index:9999;
width:60px;height:60px;border-radius:50%;
background:linear-gradient(135deg,var(--accent-2),var(--accent));
display:flex;align-items:center;justify-content:center;color:#fff;font-size:26px;
cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.18);
transition:transform .25s,opacity .25s;
}
.chat-fab:hover{transform:scale(1.05)}
.chat-fab.hidden{opacity:0;pointer-events:none}

.chat-overlay {
position:fixed;
top:0;
left:0;
right:0;
bottom:0;
display:none;
background:rgba(0,0,0,0.45);
z-index:10000;
-webkit-backdrop-filter: blur(6px);
backdrop-filter: blur(6px);
}
.chat-overlay.show{display:block}

.chat-box {
position:absolute;
top:0;
left:0;
right:0;
bottom:0;
background:var(--card);
display:grid;
grid-template-rows: auto 1fr auto;
overflow:hidden;
}

.header {
background:linear-gradient(90deg,var(--accent),var(--accent-2));
color:#fff;
padding:12px;
padding-top:calc(12px + env(safe-area-inset-top,0px));
display:flex;
align-items:center;
}
.header .title{flex:1;font-weight:700;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.header .close{cursor:pointer;font-size:28px;background:none;border:none;color:#fff;width:36px;height:36px;display:flex;align-items:center;justify-content:center;padding:0}

.area{
overflow-y:auto;
overflow-x:hidden;
padding:12px;
padding-bottom:40px;
display:flex;
flex-direction:column;
gap:8px;
-webkit-overflow-scrolling:touch;
scroll-behavior:smooth;
}

.controls{
background:var(--card);
border-top:1px solid #eee;
padding:12px;
padding-bottom:80px;
display:flex;
flex-direction:column;
gap:10px;
box-shadow:0 -4px 12px rgba(0,0,0,0.08);
}

/* Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨ Ù†Ø±Ø¬Ø¹ Ù„Ù„Ù€ padding Ø§Ù„Ø¹Ø§Ø¯ÙŠ */
@media (min-width:700px){
.controls{
padding-bottom:16px;
box-shadow:none;
}
}

.input{display:flex;gap:8px;align-items:stretch}
.input input{
flex:1;
padding:14px;
border-radius:14px;
border:1px solid #e6eef6;
font-size:15px;
min-width:0;
background:#fff;
}
.btn{
padding:12px 18px;
border-radius:14px;
border:none;
background:var(--accent);
color:#fff;
cursor:pointer;
font-weight:600;
min-width:70px;
}
.quick{display:flex;gap:8px;flex-wrap:wrap}
.quick button{
padding:10px 14px;
border-radius:12px;
border:1px dashed #ccc;
background:transparent;
font-size:13px;
cursor:pointer;
color:var(--accent);
}

.msg{display:flex;max-width:85%;flex-direction:column;word-break:break-word}
.msg.user{align-self:flex-end}
.msg.user .bubble{background:var(--user-bg);border-radius:16px 16px 0 16px;padding:10px 14px}
.msg.bot{align-self:flex-start}
.msg.bot .bubble{background:var(--bot-bg);border-radius:16px 16px 16px 0;padding:10px 14px}
.meta{font-size:11px;color:var(--muted);margin-top:4px;text-align:right}

.typing span{width:6px;height:6px;background:var(--muted);border-radius:50%;display:inline-block;animation:dot 1s infinite}
.typing span:nth-child(2){animation-delay:.18s}
.typing span:nth-child(3){animation-delay:.36s}
@keyframes dot{0%,100%{opacity:.3;transform:translateY(0)}50%{opacity:1;transform:translateY(-4px)}}

@media (min-width:700px){
.chat-overlay{
display:none;
align-items:center;
justify-content:center;
}
.chat-overlay.show{display:flex}
.chat-box{
position:relative;
width:640px;
height:90vh;
max-height:800px;
border-radius:14px;
box-shadow:0 10px 30px rgba(2,6,23,0.12);
}
.chat-fab{right:28px;bottom:28px}
}
</style>
</head>
<body>

<div class="chat-fab" id="openChat" role="button" aria-label="Ø§ÙØªØ­ Ø§Ù„Ø´Ø§Øª">ğŸ’¬</div>

<div class="chat-overlay" id="chatOverlay" aria-hidden="true">
<div class="chat-box" role="dialog" aria-modal="true" aria-label="Ø¨ÙˆØª ÙƒÙˆÙƒØ¨">
<div class="header">
<div class="title">Ø¨ÙˆØª ÙƒÙˆÙƒØ¨ â€” ÙØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø±</div>
<button class="close" id="closeChat" aria-label="Ø§ØºÙ„Ø§Ù‚">Ã—</button>
</div>
<div class="area" id="area" tabindex="0" aria-live="polite" aria-atomic="false"></div>
<div class="controls">
<div class="quick" id="quickActions" aria-hidden="false">
<button data-text="Ø£Ø±ÙŠØ¯ Ø£ÙØ¶Ù„ Ø¹Ø±Ø¶">Ø£ÙØ¶Ù„ Ø¹Ø±Ø¶</button>
<button data-text="Ù‡Ù„ ÙÙŠ Ø®ØµÙ… Ø£Ø¹Ù„Ù‰ØŸ">Ø®ØµÙ… Ø£Ø¹Ù„Ù‰</button>
<button data-text="ØªÙ…Ø§Ù…">ØªÙ…Ø§Ù…</button>
</div>
<div class="input">
<input id="inp" type="text" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..." aria-label="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ" autocomplete="off" />
<button id="btn" class="btn" aria-label="Ø£Ø±Ø³Ù„">Ø£Ø±Ø³Ù„</button>
</div>
</div>
</div>
</div>

<script>
(function(){
'use strict';

const openBtn = document.getElementById('openChat');
const overlay = document.getElementById('chatOverlay');
const closeBtn = document.getElementById('closeChat');
const area = document.getElementById('area');
const inp = document.getElementById('inp');
const btn = document.getElementById('btn');
const quick = document.getElementById('quickActions');

const WORKER_URL = 'https://kawkab.kawkab-arabia.workers.dev/';

let historyMessages = [], chatOpened = false, finalized = false;

function postToParent(action){
try{
if(window.parent && window.parent !== window){
window.parent.postMessage({action}, '*');
}
}catch(e){}
}

function safeText(s){
const d = document.createElement('div');
d.textContent = s;
return d.innerHTML;
}

function scrollToBottom(){
requestAnimationFrame(()=>{
area.scrollTop = area.scrollHeight;
});
}

function append(who, text){
const w = document.createElement('div');
w.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
const b = document.createElement('div');
b.className = 'bubble';
b.innerHTML = safeText(text);
w.appendChild(b);
const m = document.createElement('div');
m.className = 'meta';
const now = new Date();
const time = now.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
m.textContent = time;
w.appendChild(m);
area.appendChild(w);
scrollToBottom();
}

function showTyping(){
const el = document.createElement('div');
el.className = 'msg bot';
el.innerHTML = '<div class="bubble"><div class="typing" aria-hidden="true"><span></span><span></span><span></span></div></div>';
area.appendChild(el);
scrollToBottom();
return el;
}

// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù€ input Ù„Ù…Ø§ ÙŠÙØªØ­ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯
inp.addEventListener('focus', ()=>{
setTimeout(()=>{
inp.scrollIntoView({behavior:'smooth', block:'nearest'});
scrollToBottom();
}, 300);
});

// Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø© (Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯)
if(window.visualViewport){
window.visualViewport.addEventListener('resize', ()=>{
setTimeout(()=>{
inp.scrollIntoView({behavior:'smooth', block:'nearest'});
}, 150);
});
}

function openChat(){
overlay.classList.add('show');
overlay.setAttribute('aria-hidden', 'false');
openBtn.classList.add('hidden');
if(!chatOpened){
append('bot', 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙÙŠ Ø¨ÙˆØª ÙƒÙˆÙƒØ¨! Ù‚ÙˆÙ„Ù‘ÙŠ Ø¥Ù†Øª Ø¹Ø§ÙŠØ² ØªÙØ§ÙˆØ¶ Ø¹Ù„Ù‰ Ø¥ÙŠÙ‡ØŸ ğŸ˜');
chatOpened = true;
}
postToParent('chatOpened');
setTimeout(()=>{
scrollToBottom();
inp.focus();
}, 400);
}

function closeChat(){
overlay.classList.remove('show');
overlay.setAttribute('aria-hidden', 'true');
openBtn.classList.remove('hidden');
postToParent('chatClosed');
inp.blur();
setTimeout(()=> openBtn.focus(), 200);
}

async function sendToWorker(payload){
try{
const res = await fetch(WORKER_URL, {
method: 'POST',
headers: {'Content-Type':'application/json'},
body: JSON.stringify(payload),
});
return res;
}catch(e){
throw e;
}
}

async function sendMessage(){
const txt = inp.value.trim();
if(!txt || finalized) return;
append('user', txt);
inp.value = '';
const typing = showTyping();
btn.disabled = true;
inp.disabled = true;

try{
const res = await sendToWorker({messages: historyMessages.concat([{role:'user', content: txt}])});
typing.remove();
if(!res || !res.ok){
append('bot', 'Ø§Ù„Ù†Øª ÙØ§ØµÙ„ ÙˆÙ„Ø§ ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± ğŸ˜…');
} else {
const j = await res.json().catch(()=> ({}));
const reply = j.text || j.reply || 'Ù…Ø´ ÙØ§Ù‡Ù…Ùƒ Ù‚ÙˆÙŠ ğŸ˜… Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ';
append('bot', reply);
historyMessages.push({role:'user', content: txt}, {role:'assistant', content: reply});
}
}catch(e){
try{ typing.remove(); }catch(_){}
append('bot', 'Ø§Ù„Ù†Øª ÙØ§ØµÙ„ ÙˆÙ„Ø§ Ø¥ÙŠÙ‡ØŸ ğŸ˜…');
} finally {
btn.disabled = false;
inp.disabled = false;
inp.focus();
}
}

openBtn.addEventListener('click', openChat);
closeBtn.addEventListener('click', closeChat);
btn.addEventListener('click', sendMessage);
inp.addEventListener('keydown', (e)=>{
if(e.key === 'Enter') sendMessage();
});

quick.addEventListener('click', (e)=>{
if(e.target.tagName === 'BUTTON'){
inp.value = e.target.dataset.text || '';
inp.focus();
}
});

window.addEventListener('message', (ev)=>{
if(!ev.data || typeof ev.data.action !== 'string') return;
if(ev.data.action === 'closeChat') closeChat();
if(ev.data.action === 'focusInput'){
if(overlay.classList.contains('show')) setTimeout(()=> inp.focus(), 200);
}
});

window.addEventListener('keydown', (e)=>{
if(e.key === 'Escape' && overlay.classList.contains('show')) closeChat();
});

overlay.addEventListener('touchmove', (e)=>{
if(e.target === overlay) e.preventDefault();
}, {passive:false});

window.__KAWKAB_CHAT = {
open: openChat,
close: closeChat,
sendMessageText: (t)=>{
inp.value = t;
sendMessage();
}
};
})();
</script>
</body>
</html>
