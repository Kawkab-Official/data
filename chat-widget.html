<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Ø¨ÙˆØª ÙƒÙˆÙƒØ¨ â€” ÙØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø±</title>
<style>
/* 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø«ÙŠÙ… Ø¥Ù„Ù‰ Ø£Ø³ÙˆØ¯ ÙˆØ£Ø¨ÙŠØ¶ */
:root{
--accent:#1f2937; /* Dark Grey/Near Black for Header/Button/User Bubble */
--accent-2:#4b5563; /* Medium Dark Grey for hover/shadows */
--bg:#ffffff;
--card:#ffffff;
--user-bg:var(--accent);
--user-text:#ffffff;
--bot-bg:#f3f4f6; /* Light Grey */
--bot-text:var(--accent);
--muted:#6b7280;
--radius:16px;
--shadow:0 2px 8px rgba(0,0,0,0.15);
}

*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;background:transparent;font-family:"Tahoma",system-ui;overflow:hidden}

.chat-fab {
position:fixed;
bottom:calc(20px + env(safe-area-inset-bottom, 0px));
right:20px;
z-index:9999;
width:60px;height:60px;border-radius:50%;
background:var(--accent); /* Ø£Ø³ÙˆØ¯ */
display:flex;align-items:center;justify-content:center;color:#fff;
font-size:18px; /* Ø­Ø¬Ù… Ø£ØµØºØ± Ù„Ù„Ù†Øµ */
font-weight:700;
cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.4);
transition:transform .25s,opacity .25s;
}
.chat-fab::before{content:'ÙØµØ§Ù„';} /* 6. Ù†Øµ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
.chat-fab:hover{transform:scale(1.05); box-shadow:0 6px 16px rgba(0,0,0,0.5);}
.chat-fab.hidden{opacity:0;pointer-events:none}

.chat-overlay {
position:fixed;top:0;left:0;right:0;bottom:0;display:none;
background:rgba(0,0,0,0.5);z-index:10000;
-webkit-backdrop-filter: blur(8px);backdrop-filter: blur(8px);
}
.chat-overlay.show{display:block}

.chat-box {
position:absolute;top:0;left:0;right:0;bottom:0;
background:var(--bg);
display:grid;grid-template-rows: auto 1fr auto;overflow:hidden;
}

.header {
background:var(--accent); /* Ø£Ø³ÙˆØ¯ */
color:#fff;
padding:16px 12px;
padding-top:calc(16px + env(safe-area-inset-top,0px));
display:flex;align-items:center;box-shadow:0 2px 12px rgba(0,0,0,0.2);
}
.header .title{
flex:1;font-weight:700;font-size:17px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
display:flex;align-items:center;gap:8px;
}
.header .title::before{content:none;} /* Ø¥Ø²Ø§Ù„Ø© Ø±Ù…Ø² Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
.header .close{
cursor:pointer;font-size:26px;background:rgba(255,255,255,0.15);border:none;color:#fff;
width:38px;height:38px;display:flex;align-items:center;justify-content:center;padding:0;
border-radius:50%;transition:background .2s;
}
.header .close:hover{background:rgba(255,255,255,0.25)}

.area{
overflow-y:auto;overflow-x:hidden;padding:16px 12px;padding-bottom:40px;
display:flex;flex-direction:column;gap:12px;
-webkit-overflow-scrolling:touch;scroll-behavior:smooth;
}

.controls{
background:#ffffff;
border-top:1px solid #e5e7eb;
padding:12px;
padding-bottom:calc(16px + env(safe-area-inset-bottom, 0px)); /* padding for input */
display:flex;
flex-direction:column;
gap:10px;
box-shadow:0 -4px 16px rgba(0,0,0,0.06);
position:relative; /* 5. Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù€ input bar ÙÙˆÙ‚ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ */
z-index:10;
}

/* Timer Display */
.timer-container{
display:none;align-items:center;justify-content:center;padding:12px;
background:linear-gradient(135deg, #fef3c7, #fde68a);
border-radius:12px;gap:8px;animation:pulse 2s ease-in-out infinite;
}
.timer-container.active{display:flex}
.timer-text{font-size:14px;font-weight:600;color:#92400e;}
.timer-count{font-size:18px;font-weight:700;color:#b45309;min-width:35px;text-align:center;}
@keyframes pulse{
0%,100%{transform:scale(1)}
50%{transform:scale(1.02)}
}

/* Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨ Ù†Ø±Ø¬Ø¹ Ù„Ù„Ù€ padding Ø§Ù„Ø¹Ø§Ø¯ÙŠ */
@media (min-width:700px){
.controls{
padding-bottom:16px;
box-shadow:none;
}
}

.input{
display:flex;gap:8px;align-items:stretch;
}
.input input{
flex:1;padding:14px 16px;border-radius:24px;border:2px solid #e5e7eb;
font-size:15px;min-width:0;background:#ffffff;
transition:border-color .2s, box-shadow .2s;
}
.input input:focus{
outline:none;border-color:var(--accent);
box-shadow:0 0 0 3px rgba(31,41,55,0.1);
}
.btn{
padding:12px 24px;border-radius:24px;border:none;
background:var(--accent); /* Ø£Ø³ÙˆØ¯ */
color:#fff;cursor:pointer;font-weight:600;min-width:80px;
box-shadow:0 2px 8px rgba(31,41,55,0.3);
transition:transform .2s, box-shadow .2s;
}
.btn:hover{
transform:translateY(-1px);
box-shadow:0 4px 12px rgba(31,41,55,0.4);
}
.btn:active{transform:translateY(0);}
.btn:disabled{opacity:0.6;cursor:not-allowed;transform:none;}

.quick{display:flex;gap:8px;flex-wrap:wrap}
.quick button{
padding:10px 16px;border-radius:20px;border:2px solid #e5e7eb;
background:#ffffff;font-size:13px;cursor:pointer;
color:var(--accent);font-weight:500;transition:all .2s;
}
.quick button:hover{
border-color:var(--accent);
background:#e5e7eb;
transform:translateY(-1px);
}

.msg{display:flex;max-width:80%;flex-direction:column;word-break:break-word;animation:slideIn .3s ease-out;}
@keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - ÙŠÙ…ÙŠÙ† */
.msg.user{align-self:flex-end;align-items:flex-end;}
.msg.user .bubble{
background:var(--user-bg); /* Ø£Ø³ÙˆØ¯ */
color:var(--user-text);
border-radius:18px 18px 4px 18px;
padding:12px 16px;box-shadow:var(--shadow);
}

/* Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª - Ø´Ù…Ø§Ù„ */
.msg.bot{align-self:flex-start;align-items:flex-start;}
.msg.bot .bubble{
background:var(--bot-bg);
color:var(--bot-text);
border-radius:18px 18px 18px 4px;
padding:12px 16px;box-shadow:var(--shadow);border:1px solid #e5e7eb;
}

.meta{font-size:11px;color:var(--muted);margin-top:6px;padding:0 4px;}

.typing{display:flex;gap:4px;padding:4px 0;}
.typing span{width:8px;height:8px;background:var(--muted);border-radius:50%;display:inline-block;animation:dot 1.4s infinite;}
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes dot{
0%,60%,100%{opacity:.3;transform:translateY(0) scale(0.8)}
30%{opacity:1;transform:translateY(-6px) scale(1)}
}

/* Result message styling */
.result-msg{
background:linear-gradient(135deg, #dcfce7, #bbf7d0);
border:2px solid #86efac;
border-radius:16px;
padding:16px;
margin:8px 0;
text-align:center;
animation:celebrate .6s ease-out;
}
.result-msg .result-title{font-size:18px;font-weight:700;color:#15803d;margin-bottom:8px;}
.result-msg .result-value{font-size:32px;font-weight:900;color:#16a34a;text-shadow:0 2px 4px rgba(22,163,74,0.2);}
@keyframes celebrate{
0%{transform:scale(0.8) rotate(-5deg);opacity:0}
50%{transform:scale(1.05) rotate(2deg)}
100%{transform:scale(1) rotate(0);opacity:1}
}

@media (min-width:700px){
.chat-overlay{display:none;align-items:center;justify-content:center;}
.chat-overlay.show{display:flex}
.chat-box{
position:relative;width:640px;height:90vh;max-height:800px;
border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);
}
.chat-fab{right:28px;bottom:28px}
}
</style>
</head>
<body>

<div class="chat-fab" id="openChat" role="button" aria-label="Ø§ÙØªØ­ Ø´Ø§Øª Ø§Ù„ÙØµØ§Ù„"></div>

<div class="chat-overlay" id="chatOverlay" aria-hidden="true">
<div class="chat-box" role="dialog" aria-modal="true" aria-label="Ø¨ÙˆØª ÙƒÙˆÙƒØ¨">
<div class="header">
<div class="title">Ø¨ÙˆØª ÙƒÙˆÙƒØ¨ â€” ÙØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø±</div>
<button class="close" id="closeChat" aria-label="Ø§ØºÙ„Ø§Ù‚">Ã—</button>
</div>
<div class="area" id="area" tabindex="0" aria-live="polite" aria-atomic="false"></div>
<div class="controls">
<div class="timer-container" id="timerContainer">
<span class="timer-text">â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
<span class="timer-count" id="timerDisplay">60</span>
<span class="timer-text">Ø«Ø§Ù†ÙŠØ©</span>
</div>
<div class="quick" id="quickActions" aria-hidden="false">
<button data-text="Ø£Ø±ÙŠØ¯ Ø£ÙØ¶Ù„ Ø¹Ø±Ø¶">ğŸ¯ Ø£ÙØ¶Ù„ Ø¹Ø±Ø¶</button>
<button data-text="Ù‡Ù„ ÙÙŠ Ø®ØµÙ… Ø£Ø¹Ù„Ù‰ØŸ">ğŸ’° Ø®ØµÙ… Ø£Ø¹Ù„Ù‰</button>
<button data-text="ØªÙ…Ø§Ù…" data-finalize="true">âœ… ØªÙ…Ø§Ù…</button>
</div>
<div class="input">
<input id="inp" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." aria-label="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ" autocomplete="off" />
<button id="btn" class="btn" aria-label="Ø£Ø±Ø³Ù„">Ø¥Ø±Ø³Ø§Ù„</button>
</div>
</div>
</div>
</div>

<script>
(function(){
'use strict';

const openBtn = document.getElementById('openChat');
const overlay = document.getElementById('chatOverlay');
const closeBtn = document.getElementById('closeChat');
const area = document.getElementById('area');
const inp = document.getElementById('inp');
const btn = document.getElementById('btn');
const quick = document.getElementById('quickActions');
const timerContainer = document.getElementById('timerContainer');
const timerDisplay = document.getElementById('timerDisplay');

const WORKER_URL = 'https://kawkab.kawkab-arabia.workers.dev/';

let historyMessages = [], chatOpened = false, finalized = false;
let timerInterval = null;
let timeRemaining = 60;
let firstBotReplySent = false;

function postToParent(action){
try{
if(window.parent && window.parent !== window){
window.parent.postMessage({action}, '*');
}
}catch(e){}
}

function safeText(s){
const d = document.createElement('div');
d.textContent = s;
return d.innerHTML;
}

function scrollToBottom(){
requestAnimationFrame(()=>{
area.scrollTop = area.scrollHeight;
});
}

function append(who, text, isResult = false){
const w = document.createElement('div');
w.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
const b = document.createElement('div');
b.className = isResult ? 'result-msg' : 'bubble';
if(isResult){
b.innerHTML = `<div class="result-title">ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø®ØµÙ…Ùƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div><div class="result-value">${safeText(text)}</div>`;
} else {
b.innerHTML = safeText(text);
}
w.appendChild(b);
if(!isResult){
const m = document.createElement('div');
m.className = 'meta';
const now = new Date();
const time = now.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
m.textContent = time;
w.appendChild(m);
}
area.appendChild(w);
scrollToBottom();
}

function showTyping(){
const el = document.createElement('div');
el.className = 'msg bot';
el.innerHTML = '<div class="bubble"><div class="typing" aria-hidden="true"><span></span><span></span><span></span></div></div>';
area.appendChild(el);
scrollToBottom();
return el;
}

function startTimer(){
if(timerInterval) return;
timeRemaining = 60;
timerContainer.classList.add('active');
timerDisplay.textContent = timeRemaining;
timerInterval = setInterval(()=>{
timeRemaining--;
timerDisplay.textContent = timeRemaining;
if(timeRemaining <= 0){
stopTimer();
finalize();
}
}, 1000);
}

function stopTimer(){
if(timerInterval){
clearInterval(timerInterval);
timerInterval = null;
}
timerContainer.classList.remove('active');
}

/**
 * ÙˆØ¸ÙŠÙØ© Ø¬Ø¯ÙŠØ¯Ø©: Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ Ù…Ù† Ø±Ø¯ Ø§Ù„Ø¨ÙˆØª
 * @param {string} rawText Ø§Ù„Ù†Øµ Ø§Ù„Ø®Ø§Ù… Ù…Ù† Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø°ÙŠ Ù‚Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ {"discount": X}
 * @returns {{text: string, secretDiscount: number | null}} Ø§Ù„Ù†Øµ Ø§Ù„Ù†Ø¸ÙŠÙ ÙˆÙ‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…
 */
function processBotReply(rawText) {
    // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ: {"discount": X} Ø­ÙŠØ« X Ù…Ù† 00 Ø¥Ù„Ù‰ 99
    const secretCodeRegex = /\{"discount":\s*(\d{1,2})\}/;
    const match = rawText.match(secretCodeRegex);
    
    let cleanedText = rawText;
    let secretDiscount = null;

    if (match) {
        // 1. Ø§Ø³ØªØ®Ù„Ø§Øµ Ø±Ù‚Ù… Ø§Ù„Ø®ØµÙ…
        secretDiscount = parseInt(match[1], 10);
        // 2. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        cleanedText = rawText.replace(secretCodeRegex, '').trim();
    }
    
    return {
        text: cleanedText,
        // Ø±Ù‚Ù… Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù…Ø³ØªØ®Ù„Øµ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ (Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯)
        secretDiscount: secretDiscount
    };
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ù -Ù©) Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© (0-9)
function normalizeArabicNumerals(s) {
    if (!s) return s;
    const arabicMap = {
        'Ù ': '0', 'Ù¡': '1', 'Ù¢': '2', 'Ù£': '3', 'Ù¤': '4',
        'Ù¥': '5', 'Ù¦': '6', 'Ù§': '7', 'Ù¨': '8', 'Ù©': '9'
    };
    // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ù…Ø§ ÙŠÙ‚Ø§Ø¨Ù„Ù‡Ø§ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
    return s.replace(/[Ù -Ù©]/g, (match) => arabicMap[match]);
}

/**
 * ÙˆØ¸ÙŠÙØ© Ø¬Ø¯ÙŠØ¯Ø©: Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŒ Ù…Ø¹ Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ
 * @returns {number} Ø£Ù‚ØµÙ‰ Ù†Ø³Ø¨Ø© Ø®ØµÙ… ØªÙ… Ù…Ù†Ø­Ù‡Ø§.
 */
function calculateFinalDiscount(){
    const secretCodeRegex = /\{"discount":\s*(\d{1,2})\}/; // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ
    const officialDiscountRegex = /\bØ¹Ø±Ø¶\s*:\s*([0-9\u0660-\u0669]{1,2})\s*[%Ùª]/; // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø±Ø¦ÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… (ÙƒØ§Ø­ØªÙŠØ§Ø·ÙŠ)
    let maxDiscount = 5; // Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ 5%

    for(const msg of historyMessages){ 
        if(msg.role === 'assistant'){
            let currentDiscount = null;
            
            // 1. Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø®ØµÙ… Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ (Ø§Ù„Ø£ÙƒØ«Ø± Ø¯Ù‚Ø©)
            let secretMatch = msg.content.match(secretCodeRegex);
            if(secretMatch){
                currentDiscount = parseInt(secretMatch[1], 10);
            } else {
                // 2. Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø®ØµÙ… Ù…Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø±Ø¦ÙŠ
                let visibleMatch = msg.content.match(officialDiscountRegex);
                if(visibleMatch){
                    const rawDiscountStr = visibleMatch[1];
                    const westernDiscountStr = normalizeArabicNumerals(rawDiscountStr);
                    currentDiscount = parseInt(westernDiscountStr, 10);
                }
            }

            if(currentDiscount !== null && !isNaN(currentDiscount) && currentDiscount > maxDiscount){
                maxDiscount = currentDiscount;
            }
        }
    }
    // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 30% Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙˆØª
    return Math.min(maxDiscount, 30);
}

function finalize(){
    if(finalized) return;
    finalized = true;
    stopTimer();
    btn.disabled = true;
    inp.disabled = true;
    quick.style.display = 'none';

    const finalDiscount = calculateFinalDiscount(); // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«

    setTimeout(()=>{
        append('bot', `${finalDiscount}%`, true);
        setTimeout(()=>{
            append('bot', 'Ø´ÙƒØ±Ø§Ù‹ Ù„ÙŠÙƒ! ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¶ ÙˆÙ‡Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ø§Ùƒ Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§Ù‹ ğŸŠ');
        }, 1000);
    }, 500);
}

function openChat(){
overlay.classList.add('show');
overlay.setAttribute('aria-hidden', 'false');
openBtn.classList.add('hidden');
if(!chatOpened){
append('bot', 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙÙŠ Ø¨ÙˆØª ÙƒÙˆÙƒØ¨! ğŸ‰ Ù‚ÙˆÙ„Ù‘ÙŠ Ø¥Ù†Øª Ø¹Ø§ÙŠØ² ØªÙØ§ÙˆØ¶ Ø¹Ù„Ù‰ Ø¥ÙŠÙ‡ØŸ ğŸ˜');
chatOpened = true;
// Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ø±Ø¯ Ù…Ù† Ø§Ù„Ø¨ÙˆØª ÙÙŠ Ø¯Ø§Ù„Ø© sendMessage
}
postToParent('chatOpened');
setTimeout(()=>{
scrollToBottom();
inp.focus();
}, 400);
}

function closeChat(){
overlay.classList.remove('show');
overlay.setAttribute('aria-hidden', 'true');
openBtn.classList.remove('hidden');
postToParent('chatClosed');
inp.blur();
setTimeout(()=> openBtn.focus(), 200);
}

async function sendToWorker(payload){
try{
const res = await fetch(WORKER_URL, {
method: 'POST',
headers: {'Content-Type':'application/json'},
body: JSON.stringify(payload),
});
return res;
}catch(e){
throw e;
}
}

async function sendMessage(){
const txt = inp.value.trim();
if(!txt || finalized) return;

append('user', txt);
inp.value = '';

const typing = showTyping();
btn.disabled = true;
inp.disabled = true;

try{
const newMessage = {role:'user', content: txt};
const res = await sendToWorker({messages: historyMessages.concat([newMessage])});
typing.remove();

if(!res || !res.ok){
append('bot', 'Ø§Ù„Ù†Øª ÙØ§ØµÙ„ ÙˆÙ„Ø§ ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± ğŸ˜…');
} else {
    const j = await res.json().catch(()=> ({}));
    const rawReply = j.text || j.reply || 'Ù…Ø´ ÙØ§Ù‡Ù…Ùƒ Ù‚ÙˆÙŠ ğŸ˜… Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ';
    
    // ğŸ’¥ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¯: Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ø¹Ø±Ø¶
    const processed = processBotReply(rawReply);
    const replyForDisplay = processed.text;

    append('bot', replyForDisplay);
    // Ø­ÙØ¸ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø£ØµÙ„ÙŠ (Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ) ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ calculateFinalDiscount
    historyMessages.push(newMessage, {role:'assistant', content: rawReply});
}

// 2. Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ø±Ø¯ Ù…Ù† Ø§Ù„Ø¨ÙˆØª
if(!firstBotReplySent){
    startTimer();
    firstBotReplySent = true;
}

}catch(e){
try{ typing.remove(); }catch(_){}
append('bot', 'Ø§Ù„Ù†Øª ÙØ§ØµÙ„ ÙˆÙ„Ø§ Ø¥ÙŠÙ‡ØŸ ğŸ˜…');
} finally {
btn.disabled = false;
inp.disabled = false;
inp.focus();
}
}

openBtn.addEventListener('click', openChat);
closeBtn.addEventListener('click', closeChat);
btn.addEventListener('click', sendMessage);
inp.addEventListener('keydown', (e)=>{
if(e.key === 'Enter') sendMessage();
});

// Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø©: Ø²Ø± "ØªÙ…Ø§Ù…" ÙŠÙ†Ù‡ÙŠ Ø§Ù„ØªÙØ§ÙˆØ¶ Ù…Ø¨Ø§Ø´Ø±Ø©
quick.addEventListener('click', (e)=>{
if(e.target.tagName === 'BUTTON'){
    const text = e.target.dataset.text || '';
    const isFinal = e.target.dataset.finalize === 'true';

    if(isFinal){
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø²Ø± "ØªÙ…Ø§Ù…"ØŒ Ù†Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø«Ù… Ù†Ù†Ù‡ÙŠ Ø§Ù„ØµÙÙ‚Ø©
        inp.value = text;
        append('user', text);
        inp.value = '';
        finalize();
    } else {
        // Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø®Ø±Ù‰ ØªØ±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒØ¯Ø±Ø¯Ø´Ø© Ø¹Ø§Ø¯ÙŠØ©
        inp.value = text;
        sendMessage();
    }
}
});

// 5. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù€ input Ù„Ù…Ø§ ÙŠÙØªØ­ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯
inp.addEventListener('focus', ()=>{
setTimeout(()=>{
const controls = document.querySelector('.controls');
if(controls){
controls.scrollIntoView({behavior:'smooth', block:'end'}); 
}
}, 300);
});

// Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø© (Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯)
if(window.visualViewport){
window.visualViewport.addEventListener('resize', ()=>{
setTimeout(()=>{
const controls = document.querySelector('.controls');
if(controls){
controls.scrollIntoView({behavior:'smooth', block:'end'});
}
}, 100);
});
}

window.addEventListener('message', (ev)=>{
if(!ev.data || typeof ev.data.action !== 'string') return;
if(ev.data.action === 'closeChat') closeChat();
if(ev.data.action === 'focusInput'){
if(overlay.classList.contains('show')) setTimeout(()=> inp.focus(), 200);
}
});

window.addEventListener('keydown', (e)=>{
if(e.key === 'Escape' && overlay.classList.contains('show')) closeChat();
});

overlay.addEventListener('touchmove', (e)=>{
if(e.target === overlay) e.preventDefault();
}, {passive:false});

window.__KAWKAB_CHAT = {
open: openChat,
close: closeChat,
sendMessageText: (t)=>{
inp.value = t;
sendMessage();
}
};
})();
</script>
</body>
</html>
