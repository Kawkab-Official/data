<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>بوت كوكب — فصال مباشر</title>
<style>
:root{
  --accent:#0f1724;
  --accent-2:#0ea5a4;
  --bg:#f7fbff;
  --card:#ffffff;
  --user-bg:#dff7ff;
  --bot-bg:#fff8e6;
  --muted:#667085;
  --radius:16px;
  --vh:1vh;
}

/* reset */
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;background:transparent;font-family:"Tahoma",system-ui;overflow:hidden;}

/* floating button */
.chat-fab{
  position:fixed;
  bottom:calc(20px + env(safe-area-inset-bottom,0px));
  right:20px;
  z-index:9999;
  width:60px;height:60px;border-radius:50%;
  background:linear-gradient(135deg,var(--accent-2),var(--accent));
  display:flex;align-items:center;justify-content:center;color:#fff;font-size:26px;
  cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.18);
  transition:transform .25s,opacity .25s;
}
.chat-fab:hover{transform:scale(1.05)}
.chat-fab.hidden{opacity:0;pointer-events:none}

/* overlay */
.chat-overlay{
  position:fixed;inset:0;
  display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.45);z-index:10000;
  -webkit-backdrop-filter:blur(6px);
  backdrop-filter:blur(6px);
}
.chat-overlay.show{display:flex}

/* chat box */
.chat-box{
  width:100%;
  height:calc(var(--vh) * 100);
  max-height:100dvh;
  background:var(--card);
  display:flex;flex-direction:column;position:relative;
  border-radius:12px 12px 0 0;overflow:hidden;
  box-shadow:0 10px 30px rgba(2,6,23,0.12);
}

/* header */
.header{
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#fff;padding:12px;
  display:flex;align-items:center;flex-shrink:0;
  position:sticky;top:env(safe-area-inset-top,0px);z-index:100;
  padding-top:calc(12px + env(safe-area-inset-top,0px));
}
.header .title{flex:1;font-weight:700;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.header .close{cursor:pointer;font-size:28px;background:none;border:none;color:#fff;width:36px;height:36px;display:flex;align-items:center;justify-content:center;padding:0}

/* messages area */
.area{
  flex:1;padding:12px;overflow-y:auto;overflow-x:hidden;
  display:flex;flex-direction:column;gap:8px;min-height:0;
  -webkit-overflow-scrolling:touch;
  scroll-behavior:smooth;
}

/* controls */
.controls{
  padding:10px 12px calc(12px + env(safe-area-inset-bottom,0px));
  border-top:1px solid #eee;
  display:flex;flex-direction:column;gap:8px;flex-shrink:0;
  background:var(--card);
  transition:transform .3s ease;
}
.input{display:flex;gap:8px;align-items:center}
.input input{
  flex:1;padding:10px;border-radius:14px;border:1px solid #e6eef6;
  font-size:14px;min-width:0;
}
.btn{padding:10px 14px;border-radius:14px;border:none;background:var(--accent);color:#fff;cursor:pointer}
.quick{display:flex;gap:8px;flex-wrap:wrap}
.quick button{padding:8px;border-radius:12px;border:1px dashed #ccc;background:transparent;font-size:13px;cursor:pointer;color:var(--accent)}

/* messages */
.msg{display:flex;max-width:85%;flex-direction:column;word-break:break-word}
.msg.user{align-self:flex-end}
.msg.user .bubble{background:var(--user-bg);border-radius:16px 16px 0 16px;padding:10px 14px}
.msg.bot{align-self:flex-start}
.msg.bot .bubble{background:var(--bot-bg);border-radius:16px 16px 16px 0;padding:10px 14px}
.meta{font-size:11px;color:var(--muted);margin-top:4px;text-align:right}

/* typing */
.typing span{width:6px;height:6px;background:var(--muted);border-radius:50%;display:inline-block;animation:dot 1s infinite}
.typing span:nth-child(2){animation-delay:.18s}
.typing span:nth-child(3){animation-delay:.36s}
@keyframes dot{0%,100%{opacity:.3;transform:translateY(0)}50%{opacity:1;transform:translateY(-4px)}}

@media (min-width:700px){
  .chat-box{width:640px;border-radius:14px}
  .chat-fab{right:28px;bottom:28px}
}
</style>
</head>
<body>
<div class="chat-fab" id="openChat" role="button" aria-label="افتح الشات">💬</div>

<div class="chat-overlay" id="chatOverlay" aria-hidden="true">
  <div class="chat-box" role="dialog" aria-modal="true" aria-label="بوت كوكب">
    <div class="header">
      <div class="title">بوت كوكب — فصال مباشر</div>
      <button class="close" id="closeChat" aria-label="اغلاق">×</button>
    </div>

    <div class="area" id="area" tabindex="0" aria-live="polite" aria-atomic="false"></div>

    <div class="controls" id="controls">
      <div class="quick" id="quickActions">
        <button data-text="أريد أفضل عرض">أفضل عرض</button>
        <button data-text="هل في خصم أعلى؟">خصم أعلى</button>
        <button data-text="تمام">تمام</button>
      </div>

      <div class="input">
        <input id="inp" type="text" placeholder="اكتب هنا..." aria-label="اكتب رسالتك" autocomplete="off" />
        <button id="btn" class="btn" aria-label="أرسل">أرسل</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
'use strict';

/* ===== ضبط الـ vh ديناميكيًا ===== */
function setVh(){
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
setVh();
window.addEventListener('resize', setVh);
window.addEventListener('orientationchange', ()=>setTimeout(setVh,400));

/* عناصر */
const openBtn=document.getElementById('openChat');
const overlay=document.getElementById('chatOverlay');
const closeBtn=document.getElementById('closeChat');
const area=document.getElementById('area');
const inp=document.getElementById('inp');
const btn=document.getElementById('btn');
const quick=document.getElementById('quickActions');
const controls=document.getElementById('controls');

const WORKER_URL='https://kawkab.kawkab-arabia.workers.dev/';
let historyMessages=[],chatOpened=false;

/* ===== معالجة ظهور الكيبورد أو تصغير الشاشة ===== */
let lastHeight=window.innerHeight;
window.addEventListener('resize',()=>{
  const current=window.innerHeight;
  const diff=lastHeight-current;
  // لما الكيبورد يفتح أو يقفل
  if(Math.abs(diff)>100){
    lastHeight=current;
    setVh();
    // لو الكيبورد فتح (diff > 0) نحرك الكنترولز فوق
    if(diff>0){
      controls.style.transform='translateY(-20px)';
    }else{
      controls.style.transform='translateY(0)';
    }
  }
});

/* ===== الفتح والإغلاق ===== */
function postToParent(action){
  try{if(window.parent&&window.parent!==window)window.parent.postMessage({action},'*');}catch(e){}
}
openBtn.onclick=()=>{
  overlay.classList.add('show');
  openBtn.classList.add('hidden');
  if(!chatOpened){
    append('bot','أهلاً بيك في بوت كوكب! قولّي إنت عايز تفاوض على إيه؟ 😎');
    chatOpened=true;
  }
  postToParent('chatOpened');
  setTimeout(()=>inp.focus(),400);
};
closeBtn.onclick=()=>{
  overlay.classList.remove('show');
  openBtn.classList.remove('hidden');
  postToParent('chatClosed');
};

/* ===== الرسائل ===== */
function safeText(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function append(who,text){
  const w=document.createElement('div');
  w.className='msg '+(who==='user'?'user':'bot');
  const b=document.createElement('div');
  b.className='bubble';
  b.innerHTML=safeText(text);
  w.appendChild(b);
  const m=document.createElement('div');
  m.className='meta';
  m.textContent=new Date().toLocaleTimeString('ar-EG',{hour:'2-digit',minute:'2-digit'});
  w.appendChild(m);
  area.appendChild(w);
  requestAnimationFrame(()=>w.scrollIntoView({behavior:'smooth',block:'nearest'}));
}
function showTyping(){
  const el=document.createElement('div');
  el.className='msg bot';
  el.innerHTML='<div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div>';
  area.appendChild(el);
  el.scrollIntoView({behavior:'smooth',block:'nearest'});
  return el;
}

/* ===== إرسال ===== */
async function sendToWorker(payload){
  return await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
}
async function sendMessage(){
  const txt=inp.value.trim();
  if(!txt)return;
  append('user',txt);
  inp.value='';
  const typing=showTyping();
  btn.disabled=true;
  try{
    const res=await sendToWorker({messages:historyMessages.concat([{role:'user',content:txt}])});
    typing.remove();
    const j=await res.json();
    const reply=j.text||'مش فاهمك قوي 😅 جرب تاني';
    append('bot',reply);
    historyMessages.push({role:'user',content:txt},{role:'assistant',content:reply});
  }catch(e){
    typing.remove();
    append('bot','النت فاصل ولا إيه؟ 😅');
  }
  btn.disabled=false;
  inp.focus();
}

/* ===== أحداث ===== */
btn.onclick=sendMessage;
inp.onkeydown=e=>{if(e.key==='Enter')sendMessage();};
quick.onclick=e=>{if(e.target.tagName==='BUTTON'){inp.value=e.target.dataset.text;inp.focus();}};
inp.addEventListener('focus',()=>setTimeout(()=>{area.lastElementChild?.scrollIntoView({behavior:'smooth'});},300));
})();
</script>
</body>
</html>
